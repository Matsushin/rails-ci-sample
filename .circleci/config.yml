version: 2
jobs:
  build_and_test:
    docker:
      - image: circleci/ruby:2.6.5-node
        environment:
          RAILS_ENV: test
          DATABASE_HOSTNAME: '127.0.0.1'
          TZ: UTC
      - image: circleci/mysql:5.7
        environment:
          TZ: UTC
    steps:
      - checkout

      # https://discuss.circleci.com/t/using-bundler-2-0-during-ci-fails/27411/3
      - run:
          name: Configure Bundler
          command: |
            echo 'export BUNDLER_VERSION=$(cat Gemfile.lock | tail -1 | tr -d " ")' >> $BASH_ENV
            source $BASH_ENV
            gem install bundler

      - run:
          name: Update sources list
          command: sudo apt-get update

      - run:
          name: Install MySQL client
          command: |
            sudo apt-get install default-mysql-client
      - restore_cache:
          keys:
            - bundle-cache-{{ checksum "Gemfile.lock" }}
            - bundle-cache-
      - run:
          name: bundle install
          command: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
      # bundle installされたものcacheする
      - save_cache:
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: Wait for DB
          command: dockerize -wait tcp://localhost:3306 -timeout 1m

      - run:
          name: setup db
          command: bundle exec rails db:create db:migrate

      - run:
          name: Run Rspec
          command: |
            mkdir ~/rspec
            bundle exec rspec --profile 10 \
                            --format progress --format RspecJunitFormatter -o ~/rspec/rspec.xml
          when: always
      - store_test_results:
          path: ~/rspec
  deploy:
    machine:
      ruby:
        version:
          2.6.5
    steps:
      - checkout
      - run:
          name: Installing deployment dependencies
          working_directory: /
          command: |
            pip install awscli
      - add_ssh_keys:
          fingerprints:
            - "74:c8:18:ae:3a:7c:fa:f7:0d:6a:9e:32:cb:31:0d:2d"
      - run:
          name: capistrano deploy
          command: |
            set -ex
            SECURITY_GROUP_NAME="rails-ci-sample-sec"
            IP=`curl -f -s ifconfig.me`
            trap "aws ec2 revoke-security-group-ingress --group-name ${SECURITY_GROUP_NAME} --protocol tcp --port 22 --cidr ${IP}/32" 0 1 2 3 15
            aws ec2 authorize-security-group-ingress --group-name ${SECURITY_GROUP_NAME} --protocol tcp --port 22 --cidr ${IP}/32
            bundle exec cap prod deploy

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_test
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only:
                - fix-capistrano